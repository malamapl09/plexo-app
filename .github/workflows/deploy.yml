name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 25m
          script_stop: true
          script: |
            set -euo pipefail
            cd /opt/plexo/repo
            git pull origin main

            # Build images one at a time to reduce peak memory
            docker build -t ghcr.io/malamapl09/plexo-app/api:latest \
              -f apps/api/Dockerfile .

            docker build -t ghcr.io/malamapl09/plexo-app/web:latest \
              --build-arg "NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL }}" \
              --build-arg "NEXT_PUBLIC_APP_NAME=${{ vars.NEXT_PUBLIC_APP_NAME }}" \
              --build-arg "NEXT_PUBLIC_APP_LOGO=${{ vars.NEXT_PUBLIC_APP_LOGO }}" \
              -f apps/web/Dockerfile .

            cd /opt/plexo
            cp repo/docker-compose.prod.yml docker-compose.prod.yml
            cp repo/Caddyfile Caddyfile

            # Run migration before restarting
            docker compose -f docker-compose.prod.yml run --rm migrate

            # Phased restart: API first
            docker compose -f docker-compose.prod.yml up -d --no-deps api
            echo "Waiting for API health..."
            for i in $(seq 1 30); do
              if docker compose -f docker-compose.prod.yml exec -T api wget -qO- http://localhost:3000/health 2>/dev/null | grep -q '"status"'; then
                echo "API healthy"
                break
              fi
              [ "$i" -eq 30 ] && echo "WARNING: API health check timed out" && exit 1
              sleep 5
            done

            # Then restart Web
            docker compose -f docker-compose.prod.yml up -d --no-deps web
            echo "Waiting for Web health..."
            for i in $(seq 1 20); do
              STATUS=$(docker compose -f docker-compose.prod.yml exec -T web wget -qO /dev/null --server-response http://localhost:3000/ 2>&1 | grep "HTTP/" | tail -1 | awk '{print $2}' || true)
              if [ "$STATUS" = "200" ] || [ "$STATUS" = "307" ] || [ "$STATUS" = "302" ]; then
                echo "Web healthy (HTTP $STATUS)"
                break
              fi
              [ "$i" -eq 20 ] && echo "WARNING: Web health check timed out" && exit 1
              sleep 5
            done

            # Bring up remaining services (caddy, redis) if config changed
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

            # Cleanup old images and build cache
            docker image prune -f
            docker builder prune -f --filter "until=24h"
