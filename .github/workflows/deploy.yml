name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            cd /opt/plexo/repo
            git pull origin main
            docker build -t ghcr.io/malamapl09/plexo-app/api:latest -f apps/api/Dockerfile .
            docker build -t ghcr.io/malamapl09/plexo-app/web:latest \
              --build-arg NEXT_PUBLIC_API_URL=${{ vars.NEXT_PUBLIC_API_URL }} \
              --build-arg NEXT_PUBLIC_APP_NAME=${{ vars.NEXT_PUBLIC_APP_NAME }} \
              --build-arg NEXT_PUBLIC_APP_LOGO=${{ vars.NEXT_PUBLIC_APP_LOGO }} \
              -f apps/web/Dockerfile .
            cd /opt/plexo
            cp repo/docker-compose.prod.yml docker-compose.prod.yml
            cp repo/Caddyfile Caddyfile
            docker compose -f docker-compose.prod.yml run --rm migrate
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
            docker image prune -f
